<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout}">
<head>
  <title>Home</title>
  <link rel="stylesheet" th:href="@{/css/index.css}"/>
</head>
<body>

<!-- Main Content -->
<main layout:fragment="content">

  <div class="container">

    <!-- 카테고리   -->
    <div class="categoryBox">
      <div class="categories" th:each="category : ${categories}">
        <a th:href="@{/category/{category}(category=${category})}">
          <div class="categoryImgBox">
            <img th:src="@{/images/essentials/{category}.png(category=${category})}" class="categoryImg" alt="카테고리 이미지">
            <span class="categoryTitle" th:text="${category}"></span>
          </div>
        </a>
      </div>
      <div class="categories">
        <div class="categoryImgBox">
          <button class="filter-btn">
            <img th:src="@{/images/essentials/gear-solid.svg}" class="categoryImg" alt="필터 이미지">
          </button>
        </div>
      </div>
    </div>

<!--    객실    -->
    <div class="container mt-5">
      <div class="row row-cols-1 row-cols-md-3 g-4">
        <div class="col" th:each="accommodation : ${accommodations}">
          <div class="card h-100 shadow-sm">
            <a th:href="@{/accommodation/{accommodationId}(accommodationId=${accommodation.getId()})}">
              <img th:src="@{${accommodation.images != null ? accommodation.images[0].getImageUrl() : '/default-image.jpg'}}"
                   class="card-img-top" alt="Accommodation Image" style="height: 200px; object-fit: cover;">
            </a>
            <div class="card-body d-flex flex-column">
              <h5 class="card-title" th:text="${accommodation.title}"></h5>
              <p class="card-text">
                <span class="badge bg-primary me-2" th:text="${accommodation.category}"></span>
                <small class="text-muted" th:text="${accommodation.address}"></small>
              </p>
              <span class="text-muted" th:text="|Host : ${accommodation.user.getNickname()}|"></span>
              <div class="d-flex justify-content-between align-items-center mt-auto">
                <span class="h5 mb-0" th:text="${#numbers.formatDecimal(accommodation.pricePerNight, 1, 'COMMA', 0, 'POINT')} + '원'"></span>
                <div th:if="${isLoggedIn}" class="wishlist-icons">
                  <img class="wish" id="wishTrue"
                       th:classappend="${wishlistStatus.get(accommodation.id) ? '': 'remove'}"
                       th:data-accommodation-id="${accommodation.id}"
                       src="images/essentials/heart.png"
                       alt="In Wishlist"
                       th:onclick="'handleWishlistClick(' + ${accommodation.id} +', false)'"/>
                  <img class="wish" id="wishFalse"
                       th:classappend="${wishlistStatus.get(accommodation.id) ? 'remove': ''}"
                       th:data-accommodation-id="${accommodation.id}"
                       src="images/essentials/blankHeart.png"
                       alt="Not in Wishlist"
                       th:onclick="'handleWishlistClick(' + ${accommodation.id} +', true)'"/>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>


  </div>

  <script>
    // Handle wishlist click
    function handleWishlistClick(accommodationId, isInWishlist) {
      if (isInWishlist) {
        addToWishlist(accommodationId);
      } else {
        removeFromWishlist(accommodationId);
      }
    }

    // 위시리스트에 아이템을 추가합니다.
    function addToWishlist(accommodationId) {
      fetch('/api/wishlist/add/'+ accommodationId, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          // CSRF 토큰이 필요한 경우 여기에 추가
        },
      })
      .then(handleResponse)
      .then(data => {
        if (data.success) {
          console.log(`아이템 ${accommodationId}이(가) 위시리스트에 추가되었습니다.`);
          updateWishlistUI(accommodationId, true);
        } else {
          console.error(`아이템 ${accommodationId} 추가 실패: ${data.message}`);
        }
      })
      .catch(handleError);
    }

    // 위시리스트에서 아이템을 제거합니다.
    function removeFromWishlist(accommodationId) {
      fetch('/api/wishlist/remove/'+ accommodationId, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          // CSRF 토큰이 필요한 경우 여기에 추가
        },
      })
      .then(handleResponse)
      .then(data => {
        if (data.success) {
          console.log(`아이템 ${accommodationId}이(가) 위시리스트에서 제거되었습니다.`);
          updateWishlistUI(accommodationId, false);
        } else {
          console.error(`아이템 ${accommodationId} 제거 실패: ${data.message}`);
        }
      })
      .catch(handleError);
    }

    // 서버 응답을 처리합니다.
    function handleResponse(response) {
      if (!response.ok) {
        throw new Error(`HTTP 에러: ${response.status}`);
      }
      return response.json();
    }

    // 에러를 처리합니다.
    function handleError(error) {
      console.error('에러 발생:', error.message);
      // 사용자에게 에러 메시지를 보여주기 위한 추가 로직을 여기에 추가할 수 있습니다.
    }

    // UI 업데이트를 위한 헬퍼 함수
    function updateWishlistUI(accommodationId, isInWishlist) {
      const wishTrue = document.getElementById("wishTrue");
      const wishFalse = document.getElementById("wishFalse");
      if (wishTrue && wishFalse) {
        if (isInWishlist) {
          wishTrue.classList.remove("remove");
          wishFalse.classList.add("remove");
        } else {
          wishTrue.classList.add("remove");
          wishFalse.classList.remove("remove");
        }
      } else {
        console.error('One or both elements not found: wishTrue or wishFalse');
      }
    }


  </script>
</main>
</body>
</html>
